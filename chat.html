<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        /* üÜï FIXED: Better message spacing to prevent overlap */
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlide 0.3s ease-out;
            margin-top: 25px; /* üÜï INCREASED: More space for labels */
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* üÜï FIXED: Bot message styling with better label positioning */
        .bot-message {
            background: #f3f4f6;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .bot-message::before {
            content: "ü§ñ Chatbot";
            position: absolute;
            top: -22px; /* üÜï FIXED: Better positioning */
            left: 0;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9); /* üÜï NEW: Background for visibility */
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        /* üÜï FIXED: Operator message styling with better label positioning */
        .operator-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #047857;
            position: relative;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .operator-message::before {
            content: "üë®‚Äçüíº Team Member";
            position: absolute;
            top: -22px; /* üÜï FIXED: Better positioning */
            left: 0;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9); /* üÜï NEW: Background for visibility */
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .user-message {
            background: var(--brand-color, #8B5CF6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            margin-top: 25px; /* üÜï CONSISTENT: Same spacing */
        }

        /* üÜï FIXED: System message styling - no overlap issues */
        .system-message {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 1px solid #f59e0b;
            color: #92400e;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            border-radius: 20px;
            padding: 12px 16px;
            margin: 15px 0; /* üÜï FIXED: Better spacing */
            font-weight: 600;
            animation: systemMessageAppear 0.5s ease-out;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        @keyframes systemMessageAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .quick-reply {
            padding: 8px 14px;
            border: 1px solid var(--brand-color, #8B5CF6);
            border-radius: 18px;
            background: white;
            color: var(--brand-color, #8B5CF6);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-reply:hover {
            background: var(--brand-color, #8B5CF6);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--brand-color, #8B5CF6);
        }

        .send-button {
            padding: 12px 20px;
            background: var(--brand-color, #8B5CF6);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .send-button:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Enhanced typing indicator */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 16px;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .typing-indicator.operator-typing {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .typing-indicator.operator-typing::before {
            content: "üë®‚Äçüíº Team member is typing...";
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 11px;
            color: #059669;
            font-weight: 600;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        .loading-message {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--brand-color, #8B5CF6);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Enhanced Contact Form */
        .contact-form {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid var(--brand-color, #8B5CF6);
            border-radius: 16px;
            padding: 24px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .contact-form h4 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .contact-form p {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 18px;
            line-height: 1.5;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 18px;
        }

        .contact-form input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .contact-form input:focus {
            border-color: var(--brand-color, #8B5CF6);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 12px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .submit-btn {
            background: var(--brand-color, #8B5CF6);
            color: white;
        }

        .submit-btn:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .skip-btn {
            background: transparent;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .skip-btn:hover {
            border-color: #d1d5db;
            color: #4b5563;
            background: #f9fafb;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 12px;
            line-height: 1.4;
        }

        /* Business info display */
        .business-info {
            background: linear-gradient(135deg, var(--brand-color, #8B5CF6), var(--brand-color-dark, #7C3AED));
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .business-info h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .business-info p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        /* üÜï IMPROVED: Better responsive design */
        @media (max-width: 768px) {
            .message {
                max-width: 95%;
                font-size: 16px;
                margin-top: 30px; /* üÜï MORE: Extra space on mobile */
            }
            
            .message::before {
                font-size: 10px;
                top: -20px; /* üÜï FIXED: Better mobile positioning */
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .quick-replies {
                gap: 4px;
            }
            
            .quick-reply {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .system-message {
                font-size: 13px;
                max-width: 95%;
                margin: 20px 0; /* üÜï MORE: Extra spacing on mobile */
            }
        }

        /* Accessibility improvements */
        .message a {
            color: inherit;
            text-decoration: underline;
            text-decoration-color: rgba(255,255,255,0.5);
        }

        .bot-message a {
            color: var(--brand-color, #8B5CF6);
            text-decoration-color: var(--brand-color, #8B5CF6);
        }

        .operator-message a {
            color: white;
            text-decoration-color: rgba(255,255,255,0.7);
        }

        /* Error states */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="chat-messages" id="chatMessages">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            Loading chat...
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="chat-input-container">
        <input 
            type="text" 
            class="chat-input" 
            id="chatInput" 
            placeholder="Type your question..."
            onkeypress="handleKeyPress(event)"
            disabled
        >
        <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script>
        // üÜï DEBUG: Enhanced debugging for troubleshooting
        console.log('=== ENHANCED CHAT DEBUG START ===');
        console.log('URL:', window.location.href);
        console.log('URL params:', window.location.search);

        let operatorId = null;
        let businessConfig = null;
        let serverUrl = 'https://wherewolf-chatbot.onrender.com';
        let isFirstMessage = true;
        let hasProvidedContact = false;
        let pendingMessage = null;

        // üÜï IMPROVED: Faster two-way chat variables
        let pollingInterval = null;
        let lastMessageCount = 0;

        // Get operator ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        operatorId = urlParams.get('operator');

        console.log('Operator ID from URL:', operatorId);
        console.log('Server URL:', serverUrl);

        if (!operatorId) {
            console.error('‚ùå No operator ID provided in URL');
            showError('Error: No operator ID provided');
        } else {
            console.log('‚úÖ Starting chat initialization...');
            loadOperatorConfig();
        }

        // üÜï ENHANCED: Better config loading with debugging
        async function loadOperatorConfig() {
            try {
                console.log('üîç Loading config for operator:', operatorId);
                
                const configUrl = `${serverUrl}/api/config/${operatorId}`;
                console.log('üì° Fetching from:', configUrl);
                
                const response = await fetch(configUrl);
                console.log('üì® Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Config fetch failed:', errorText);
                    throw new Error(`Config not found (${response.status}): ${errorText}`);
                }
                
                businessConfig = await response.json();
                console.log('‚úÖ Config loaded successfully:', businessConfig);
                
                // Apply branding
                applyBranding(businessConfig);
                
                // Initialize chat with enhanced welcome message
                initializeEnhancedChat();
                
                // üÜï NEW: Load conversation history if exists
                loadConversationHistory();
                
                console.log('üéâ Chat initialization complete!');
                
            } catch (error) {
                console.error('üí• Config loading error:', error);
                showError(`Error loading chat: ${error.message}. Please check the operator ID and try again.`);
            }
        }

        // üÜï NEW: Load conversation history when chat loads
        async function loadConversationHistory() {
            try {
                const response = await fetch(`${serverUrl}/api/chat/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        operatorId: operatorId,
                        sessionId: 'default'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        const messagesContainer = document.getElementById('chatMessages');
                        messagesContainer.innerHTML = ''; // Clear loading message
                        
                        // Display all historical messages
                        data.messages.forEach(msg => {
                            displayMessage(msg.content, msg.role);
                        });
                        
                        // If conversation had operator involvement, start polling
                        if (data.hasOperator || data.agentRequested) {
                            console.log('üîÑ Previous operator involvement detected, starting polling...');
                            startOperatorMessagePolling();
                            isFirstMessage = false; // Skip contact form since conversation already started
                        }
                        
                        // Update lastMessageCount for polling
                        lastMessageCount = data.messages.length;
                    }
                }
            } catch (error) {
                console.error('Error loading conversation history:', error);
                // Continue normally if history load fails
            }
        }

        // Apply branding from config
        function applyBranding(config) {
            const brandColor = config.brandColor || '#8B5CF6';
            const brandColorDark = darkenColor(brandColor, 15);
            
            // Set CSS custom properties
            document.documentElement.style.setProperty('--brand-color', brandColor);
            document.documentElement.style.setProperty('--brand-color-dark', brandColorDark);
            
            console.log('üé® Applied branding:', brandColor);
        }

        // Helper function to darken colors
        function darkenColor(hex, percent = 15) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // Initialize enhanced chat interface
        function initializeEnhancedChat() {
            const businessName = businessConfig.businessName || 'our business';
            const businessType = businessConfig.businessType || 'tours';
            const companyTagline = businessConfig.companyTagline || '';
            const customGreeting = businessConfig.customGreeting || '';
            
            // Use custom greeting if provided, otherwise use default
            let welcomeMessage;
            if (customGreeting && customGreeting.trim() && customGreeting !== 'Hi! Welcome to [Business Name]. I\'m here to help you plan your perfect adventure!') {
                // Use custom greeting and replace placeholder
                welcomeMessage = customGreeting.replace(/\[Business Name\]/g, businessName);
            } else {
                // Use default greeting format - but be smart about tagline
                let businessDisplayName = businessName;
                
                // Only add tagline if it's reasonable (not too long, not weird)
                if (companyTagline && 
                    companyTagline.length < 50 && 
                    !companyTagline.toLowerCase().includes('live, laugh, love') &&
                    companyTagline.trim() !== businessName) {
                    businessDisplayName = `${businessName} - ${companyTagline}`;
                }
                
                welcomeMessage = `üëã Hi! Welcome to ${businessDisplayName}. I'm here to help with your ${businessType} questions. What would you like to know?`;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            
            // Only show welcome if no history was loaded
            if (messagesContainer.querySelector('.loading-message')) {
                messagesContainer.innerHTML = '';

                // Add business info card if we have extra details
                if (businessConfig.websiteUrl || businessConfig.phoneNumber || businessConfig.businessHours) {
                    const businessInfoHtml = `
                        <div class="message bot-message">
                            <div class="business-info">
                                <h4>${businessName}</h4>
                                <p>${companyTagline && companyTagline !== businessName ? companyTagline : `Your trusted ${businessType} provider`}</p>
                            </div>
                        </div>
                    `;
                    messagesContainer.insertAdjacentHTML('beforeend', businessInfoHtml);
                }

                // Add main welcome message
                const welcomeHtml = `
                    <div class="message bot-message">
                        <div>${welcomeMessage}</div>
                        <div class="quick-replies">
                            <button class="quick-reply" onclick="sendQuickReply('What are your tour times?')">üïí Tour Times</button>
                            <button class="quick-reply" onclick="sendQuickReply('How much does it cost?')">üí∞ Pricing</button>
                            <button class="quick-reply" onclick="sendQuickReply('Where do I meet you?')">üìç Location</button>
                            <button class="quick-reply" onclick="sendQuickReply('What should I bring?')">üéí What to Bring</button>
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', welcomeHtml);
            }

            // Enable input
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.placeholder = "Type your question...";
            chatInput.focus();
            
            console.log('üí¨ Chat interface ready!');
        }

        // üÜï ENHANCED: Better error display
        function showError(message) {
            console.error('Showing error:', message);
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Chat Loading Error</h3>
                    <p>${message}</p>
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                        <strong>Debug Info:</strong><br>
                        Operator ID: ${operatorId || 'Not provided'}<br>
                        URL: ${window.location.href}
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="/setup" style="color: #8B5CF6; text-decoration: underline;">‚Üê Go to Setup</a>
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input while processing
            input.disabled = true;
            sendButton.disabled = true;
            
            // Display user message
            displayMessage(message, 'user');
            input.value = '';
            
            // If this is the first message and we haven't collected contact info yet
            if (isFirstMessage && !hasProvidedContact) {
                isFirstMessage = false;
                pendingMessage = message; // Store the message
                showContactForm(); // Show contact form first
            } else {
                // Normal message flow - send directly to server
                await sendMessageToServer(message);
            }
            
            // Re-enable input
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }

        // Enhanced contact form
        function showContactForm() {
            const businessName = businessConfig.businessName || 'our business';
            const responseTime = businessConfig.responseTime || '30 minutes';
            
            const contactFormHtml = `
                <div class="message bot-message">
                    <div class="contact-form">
                        <h4>üëã Quick question first!</h4>
                        <p>Could we get your email so we can send you ${businessConfig.businessType || 'tour'} info and follow up if needed? We typically respond within ${responseTime}.</p>
                        <div class="form-row">
                            <input 
                                type="email" 
                                id="contactEmail" 
                                placeholder="your@email.com" 
                                onkeypress="if(event.key==='Enter') submitContact()"
                            >
                            <input 
                                type="tel" 
                                id="contactPhone" 
                                placeholder="Phone (optional)" 
                                onkeypress="if(event.key==='Enter') submitContact()"
                            >
                        </div>
                        <div class="form-buttons">
                            <button class="submit-btn" onclick="submitContact()">Continue ‚Üí</button>
                            <button class="skip-btn" onclick="skipContact()">Skip for now</button>
                        </div>
                        <p class="help-text">We'll use this to send you ${businessConfig.businessType || 'tour'} details and follow up if you have questions later</p>
                    </div>
                </div>
            `;
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.insertAdjacentHTML('beforeend', contactFormHtml);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Focus on email input
            setTimeout(() => {
                document.getElementById('contactEmail').focus();
            }, 100);
        }

        // Submit contact information
        async function submitContact() {
            const email = document.getElementById('contactEmail').value;
            const phone = document.getElementById('contactPhone').value;
            
            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                const emailInput = document.getElementById('contactEmail');
                emailInput.style.borderColor = '#EF4444';
                emailInput.placeholder = 'Please enter a valid email';
                emailInput.value = '';
                emailInput.focus();
                return;
            }
            
            hasProvidedContact = true;
            
            try {
                // Send contact info to server
                await fetch(`${serverUrl}/contact-info`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        email, 
                        phone, 
                        operatorId: operatorId,
                        sessionId: 'default'
                    })
                });
                
                console.log('üìß Contact info saved:', { email, phone, operatorId });
                
                // Replace contact form with success message
                const lastMessage = document.querySelector('.message:last-child');
                lastMessage.innerHTML = `
                    <div style="
                        color: #059669; 
                        font-weight: 600; 
                        font-size: 14px;
                        text-align: center;
                        padding: 16px;
                        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                        border-radius: 12px;
                        border: 1px solid #a7f3d0;
                    ">
                        ‚ú® Perfect! Now let me help you with your question...
                    </div>
                `;
                
                // Send the original message after a brief delay
                setTimeout(async () => {
                    if (pendingMessage) {
                        await sendMessageToServer(pendingMessage);
                        pendingMessage = null;
                    }
                }, 1500);
                
            } catch (error) {
                console.error('Error saving contact:', error);
                skipContact(); // Fallback to skip if error
            }
        }

        // Skip contact form
        function skipContact() {
            hasProvidedContact = true;
            const lastMessage = document.querySelector('.message:last-child');
            lastMessage.remove();
            
            // Send the pending message
            if (pendingMessage) {
                sendMessageToServer(pendingMessage);
                pendingMessage = null;
            }
        }

        // üÜï UPDATED: Enhanced Chat endpoint with operator message detection
app.post('/api/chat', async function(req, res) {
    const { message, sessionId = 'default', operatorId } = req.body;

    if (!message) {
        return res.status(400).json({ error: "Message is required" });
    }
    if (!operatorId) {
        return res.status(400).json({ error: "operatorId is required for chat" });
    }

    const sessionKey = `${operatorId}_${sessionId}`;

    // Get or create conversation in database
    const conversation = await getOrCreateConversation(operatorId, sessionKey);
    if (!conversation) {
        return res.status(500).json({ error: 'Failed to manage conversation' });
    }

    // Save user message to database
    await saveMessage(conversation.conversation_id, 'user', message);

    // Load operator config
    let currentConfig;
    try {
        currentConfig = await getOperatorConfig(operatorId);
        if (!currentConfig) {
            return res.status(404).json({ error: 'Operator config not found.' });
        }
    } catch (error) {
        console.error(`Error loading config for operatorId ${operatorId}:`, error);
        return res.status(500).json({ error: 'Failed to load operator configuration.' });
    }

    // Initialize in-memory conversation for Claude API
    if (!conversations[sessionKey]) {
        conversations[sessionKey] = [];
    }
    conversations[sessionKey].push({ role: 'user', content: message });

    // üÜï FIXED: Check if operator has taken over AND if we've already notified
    const operatorCheckResult = await pool.query(
        'SELECT COUNT(*) FROM messages WHERE conversation_id = $1 AND role = $2',
        [conversation.conversation_id, 'operator']
    );

    const hasOperatorMessages = parseInt(operatorCheckResult.rows[0].count) > 0;
    
    // üÜï NEW: Check if we've already sent the operator notification
    const notificationCheckResult = await pool.query(
        `SELECT COUNT(*) FROM messages 
         WHERE conversation_id = $1 
         AND role = 'assistant' 
         AND content LIKE '%team member will respond shortly%'`,
        [conversation.conversation_id]
    );
    
    const hasAlreadyNotified = parseInt(notificationCheckResult.rows[0].count) > 0;

    // üÜï FIXED: Only show the notification ONCE when operator first joins
    if (hasOperatorMessages && !hasAlreadyNotified) {
        const operatorResponse = "Thanks for your message! Our team member will respond shortly in this chat.";
        conversations[sessionKey].push({ role: 'assistant', content: operatorResponse });
        await saveMessage(conversation.conversation_id, 'assistant', operatorResponse);
        
        return res.json({ 
            response: operatorResponse,
            operatorJoined: true,
            twoWayChat: true,
            startPolling: true
        });
    } else if (hasOperatorMessages && hasAlreadyNotified) {
        // üÜï NEW: Operator is active but we've already notified - just acknowledge without bot response
        return res.json({ 
            response: null, // No bot response needed
            skipBotResponse: true, // Tell client to skip showing a bot response
            operatorActive: true,
            twoWayChat: true,
            continuePolling: true
        });
    }

    const lowerMessage = message.toLowerCase();
    const waiverLink = currentConfig.waiverLink || "No waiver link provided.";

    // Agent request detection
    const defaultAgentKeywords = [
        'agent', 'human', 'speak to someone', 'talk to someone', 
        'representative', 'person', 'staff', 'manager', 'urgent'
    ];
    
    let customTriggers = [];
    if (currentConfig.handoffTriggers) {
        customTriggers = currentConfig.handoffTriggers.split(',').map(t => t.trim().toLowerCase());
    }
    
    const allAgentKeywords = [...defaultAgentKeywords, ...customTriggers];
    const isAgentRequest = allAgentKeywords.some(keyword => lowerMessage.includes(keyword)) ||
        lowerMessage.includes('call me') ||
        (lowerMessage.includes('phone') && lowerMessage.includes('call') && lowerMessage.length < 20);

    const handoffKey = `handoff_${sessionKey}`;
    const alreadyHandedOff = conversations[handoffKey] || false;

    if (isAgentRequest && !alreadyHandedOff) {
        conversations[handoffKey] = true;
        await markAgentRequested(sessionKey);
        
        const customerContact = customerContacts[sessionKey];
        const responseTime = currentConfig.responseTime || "30 minutes";
        
        let botResponse;
        
        // Check alert preference for proper response
        if (currentConfig.alertPreference === 'dashboard') {
            // Two-way chat mode
            botResponse = `I'm connecting you with our team right away! üë• They'll respond directly in this chat within ${responseTime}. Feel free to continue typing your questions.`;
            
            if (customerContact && (customerContact.email || customerContact.phone)) {
                if (emailTransporter) {
                    await sendHandoffEmail(currentConfig, conversations[sessionKey], customerContact, operatorId);
                }
            }
            
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            
            return res.json({ 
                response: botResponse, 
                agentRequested: true,
                twoWayChat: true,
                startPolling: true
            });
        } else {
            // Regular email/phone contact mode
            if (customerContact && (customerContact.email || customerContact.phone)) {
                if (emailTransporter) {
                    await sendHandoffEmail(currentConfig, conversations[sessionKey], customerContact, operatorId);
                }
                botResponse = `I'm connecting you with our team right away! üë• Someone will reach out within ${responseTime}. You can also continue chatting here and they'll respond directly.`;
            } else {
                botResponse = `I'd love to connect you with our team! üë• First, I'll need your contact information. What's your email address so our team can reach out within ${responseTime}?`;
            }
            
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            return res.json({ response: botResponse, agentRequested: true });
        }
    }

    // Handle agent handoff follow-ups (keeping existing logic)
    if (alreadyHandedOff) {
        const customerContact = customerContacts[sessionKey];
        const responseTime = currentConfig.responseTime || "30 minutes";
        
        const emailRegex = /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/;
        const phoneRegex = /\b\d{3}[-.]?\d{3}[-.]?\d{4}\b|\b\(\d{3}\)\s?\d{3}[-.]?\d{4}\b/;
        
        if (emailRegex.test(message)) {
            const email = message.match(emailRegex)[0];
            customerContacts[sessionKey] = { ...customerContacts[sessionKey], email };
            await updateCustomerContact(sessionKey, email, null);
            
            if (emailTransporter) {
                await sendHandoffEmail(currentConfig, conversations[sessionKey], { email }, operatorId);
            }
            
            const botResponse = `Perfect! I've saved your email (${email}) and our team has been notified. They'll reach out within ${responseTime}. Is there anything else I can help you with while you wait?`;
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            return res.json({ response: botResponse });
        } else if (phoneRegex.test(message)) {
            const phone = message.match(phoneRegex)[0];
            customerContacts[sessionKey] = { ...customerContacts[sessionKey], phone };
            await updateCustomerContact(sessionKey, null, phone);
            
            if (emailTransporter) {
                await sendHandoffEmail(currentConfig, conversations[sessionKey], { phone }, operatorId);
            }
            
            const botResponse = `Perfect! I've saved your phone number (${phone}) and our team has been notified. They'll call you within ${responseTime}. Is there anything else I can help you with while you wait?`;
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            return res.json({ response: botResponse });
        } else if (lowerMessage.includes('phone') || lowerMessage.includes('call')) {
            if (customerContact && customerContact.phone) {
                const botResponse = `Perfect! Our team will call you at ${customerContact.phone} within ${responseTime}. Is there anything else I can help you with while you wait?`;
                conversations[sessionKey].push({ role: 'assistant', content: botResponse });
                await saveMessage(conversation.conversation_id, 'assistant', botResponse);
                return res.json({ response: botResponse });
            } else {
                const botResponse = `Perfect! What's your phone number so our team can call you within ${responseTime}?`;
                conversations[sessionKey].push({ role: 'assistant', content: botResponse });
                await saveMessage(conversation.conversation_id, 'assistant', botResponse);
                return res.json({ response: botResponse });
            }
        } else if (lowerMessage.includes('email')) {
            if (customerContact && customerContact.email) {
                const botResponse = `Perfect! Our team will email you at ${customerContact.email} within ${responseTime}. Is there anything else I can help you with while you wait?`;
                conversations[sessionKey].push({ role: 'assistant', content: botResponse });
                await saveMessage(conversation.conversation_id, 'assistant', botResponse);
                return res.json({ response: botResponse });
            } else {
                const botResponse = `Perfect! What's your email address so our team can reach out within ${responseTime}?`;
                conversations[sessionKey].push({ role: 'assistant', content: botResponse });
                await saveMessage(conversation.conversation_id, 'assistant', botResponse);
                return res.json({ response: botResponse });
            }
        } else if (isAgentRequest) {
            const botResponse = `Our team has already been notified and will reach out within ${responseTime}! Is there anything else I can help you with while you wait, or would you like me to provide our direct contact information?`;
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            return res.json({ response: botResponse });
        }
    }

    // Handle waiver requests
    if (lowerMessage.includes('waiver') || lowerMessage.includes('form') || lowerMessage.includes('sign') || lowerMessage.includes('release')) {
        const botResponse = `Here's your waiver: <a href='${waiverLink}' target='_blank' style='color: ${currentConfig.brandColor || '#8B5CF6'};'>Click here to sign</a>`;
        conversations[sessionKey].push({ role: 'assistant', content: botResponse });
        await saveMessage(conversation.conversation_id, 'assistant', botResponse);
        return res.json({ response: botResponse });
    }

    // Handle pricing questions
    if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('pricing')) {
        if (currentConfig.bookingLink) {
            const botResponse = `For current pricing and availability, please check our booking system: <a href='${currentConfig.bookingLink}' target='_blank' style='color: ${currentConfig.brandColor || '#8B5CF6'};'>View prices and book here</a>. Our team can also help with pricing questions if you need assistance!`;
            conversations[sessionKey].push({ role: 'assistant', content: botResponse });
            await saveMessage(conversation.conversation_id, 'assistant', botResponse);
            return res.json({ response: botResponse });
        }
    }

    // Handle booking requests
    if (currentConfig.bookingLink && (lowerMessage.includes('book') || lowerMessage.includes('reserve') || lowerMessage.includes('schedule'))) {
        const botResponse = `Ready to book? <a href='${currentConfig.bookingLink}' target='_blank' style='color: ${currentConfig.brandColor || '#8B5CF6'};'>Click here to book online</a> or speak to someone from our team for assistance!`;
        conversations[sessionKey].push({ role: 'assistant', content: botResponse });
        await saveMessage(conversation.conversation_id, 'assistant', botResponse);
        return res.json({ response: botResponse });
    }

    // Normal conversation with Claude API
    const SYSTEM_PROMPT = buildEnhancedSystemPrompt(currentConfig);

    try {
        let maxTokens = 100;
        switch (currentConfig.responseLength) {
            case "Detailed (3-4 sentences)":
                maxTokens = 150;
                break;
            case "Moderate (2-3 sentences)":
                maxTokens = 120;
                break;
            default:
                maxTokens = 100;
        }

        const response = await axios.post('https://api.anthropic.com/v1/messages', {
            model: 'claude-3-haiku-20240307',
            max_tokens: maxTokens,
            temperature: currentConfig.chatbotTone === 'Enthusiastic' ? 0.7 : 0.5,
            system: SYSTEM_PROMPT,
            messages: conversations[sessionKey]
        }, {
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': process.env.CLAUDE_API_KEY,
                'anthropic-version': '2023-06-01'
            }
        });

        const botResponse = response.data.content[0].text;
        conversations[sessionKey].push({ role: 'assistant', content: botResponse });
        await saveMessage(conversation.conversation_id, 'assistant', botResponse);

        if (conversations[sessionKey].length > 20) {
            conversations[sessionKey] = conversations[sessionKey].slice(-20);
        }

        res.json({ response: botResponse });

    } catch (error) {
        console.error('Error with Claude API:', error.response?.data || error.message);

        let fallbackResponse = `Sorry, I'm having connection issues. For immediate help, please speak to someone from our team!`;
        
        conversations[sessionKey].push({ role: 'assistant', content: fallbackResponse });
        await saveMessage(conversation.conversation_id, 'assistant', fallbackResponse);
        res.json({ response: fallbackResponse });
    }
});
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì® Server response:', data);
                hideTyping();
                
                // Check if response indicates operator takeover
                if (data.operatorJoined) {
                    displayMessage('üë®‚Äçüíº A team member has joined the chat to assist you personally!', 'system');
                }
                
                // Display the response (could be from bot or operator)
                displayMessage(data.response, data.fromOperator ? 'operator' : 'bot');
                
                // üÜï IMPROVED: Better handling of different chat modes
                if (data.agentRequested || data.operatorJoined || data.startPolling || data.twoWayChat) {
                    console.log('üîÑ Starting message polling...');
                    startOperatorMessagePolling();
                    
                    // üÜï NEW: Different indicators for different modes
                    if (data.twoWayChat) {
                        setTimeout(() => {
                            const indicator = document.createElement('div');
                            indicator.id = 'waiting-indicator';
                            indicator.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
                                color: white;
                                padding: 12px 20px;
                                border-radius: 25px;
                                font-size: 14px;
                                font-weight: 600;
                                z-index: 10002;
                                box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
                                animation: pulse 2s infinite;
                            `;
                            indicator.innerHTML = 'üí¨ Two-way chat active - team member will respond here!';
                            document.body.appendChild(indicator);
                            
                            // Remove indicator after 20 seconds
                            setTimeout(() => {
                                if (document.getElementById('waiting-indicator')) {
                                    indicator.remove();
                                }
                            }, 20000);
                        }, 2000);
                    } else if (data.agentRequested) {
                        setTimeout(() => {
                            const indicator = document.createElement('div');
                            indicator.id = 'waiting-indicator';
                            indicator.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                                color: white;
                                padding: 12px 20px;
                                border-radius: 25px;
                                font-size: 14px;
                                font-weight: 600;
                                z-index: 10002;
                                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                                animation: pulse 2s infinite;
                            `;
                            indicator.innerHTML = 'üë®‚Äçüíº Team member will contact you soon...';
                            document.body.appendChild(indicator);
                            
                            // Remove indicator after 30 seconds
                            setTimeout(() => {
                                if (document.getElementById('waiting-indicator')) {
                                    indicator.remove();
                                }
                            }, 30000);
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('üí• Chat error:', error);
                hideTyping();
                displayMessage('Sorry, I\'m having connection issues. Please try again or contact us directly.', 'bot');
            }
        }

        function sendQuickReply(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        // Enhanced displayMessage function with operator message support
        function displayMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            // Determine message type and styling
            let messageClass = `message ${sender}-message`;
            let displayText = text;
            
            if (sender === 'operator') {
                messageClass = 'message operator-message';
                displayText = text;
            } else if (sender === 'system') {
                messageClass = 'message system-message';
            }
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = displayText;
            messagesContainer.appendChild(messageDiv);
            
            // Smooth scroll to bottom
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function showTyping() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('chatMessages');
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // üÜï IMPROVED: Faster polling for better responsiveness
        function startOperatorMessagePolling() {
            if (pollingInterval) return; // Already polling
            
            console.log('üîÑ Starting FAST operator message polling...');
            
            // Poll every 1 second instead of 3 for better responsiveness
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${serverUrl}/api/chat/poll-messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            operatorId: operatorId,
                            lastMessageCount: lastMessageCount
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.newMessages && data.newMessages.length > 0) {
                            console.log('üì¨ New messages:', data.newMessages.length);
                            data.newMessages.forEach(msg => {
                                if (msg.role === 'operator') {
                                    displayMessage(msg.content, 'operator');
                                    
                                    // üÜï NEW: Show notification for operator messages
                                    if (document.hidden) {
                                        showNotification('Team member responded!', msg.content);
                                    }
                                } else if (msg.role === 'system') {
                                    displayMessage(msg.content, 'system');
                                }
                            });
                            
                            lastMessageCount = data.totalMessages;
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                    // If polling fails, retry with exponential backoff
                    setTimeout(() => {
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                            pollingInterval = null;
                            startOperatorMessagePolling(); // Restart polling
                        }
                    }, 5000);
                }
            }, 1000); // üÜï FIXED: Poll every 1 second for faster responses
        }

        // üÜï NEW: Browser notification function
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body.substring(0, 100) + (body.length > 100 ? '...' : ''),
                    icon: '/favicon.ico'
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification(title, {
                            body: body.substring(0, 100) + (body.length > 100 ? '...' : ''),
                            icon: '/favicon.ico'
                        });
                    }
                });
            }
        }

        // Stop polling when chat is closed
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        // üÜï NEW: Auto-restart polling if user comes back to page
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && lastMessageCount > 0 && !pollingInterval) {
                // User came back to page - restart polling if needed
                startOperatorMessagePolling();
            }
        });

        // Auto-resize input on mobile
        window.addEventListener('resize', function() {
            const chatInput = document.getElementById('chatInput');
            if (window.innerWidth <= 768) {
                chatInput.style.fontSize = '16px'; // Prevent zoom on iOS
            }
        });

        // üÜï NEW: Heartbeat to keep connection alive
        setInterval(() => {
            if (pollingInterval) {
                // Send a tiny heartbeat request
                fetch(`${serverUrl}/api/test`, { method: 'HEAD' }).catch(() => {});
            }
        }, 30000); // Every 30 seconds

        console.log('üéâ Enhanced chat script loaded successfully!');
    </script>
</body>
</html>
