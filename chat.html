<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlide 0.3s ease-out;
            margin-top: 45px;
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background: #f3f4f6;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .bot-message::before {
            content: "ü§ñ Chatbot";
            position: absolute;
            top: -22px;
            left: 0;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .operator-message {
    background: linear-gradient(135deg, #00D3C9 0%, #00a8a0 100%);  /* Teal gradient */
    color: white;
    align-self: flex-start;
    border-bottom-left-radius: 6px;
    border: 1px solid #00897b;
    position: relative;
    box-shadow: 0 2px 4px rgba(0, 211, 201, 0.3);
    margin-top: 35px;  /* Prevent overlap */
}

.operator-message::before {
    content: "üë®‚Äçüíº Team Member";
    position: absolute;
    top: -22px;
    left: 0;
    font-size: 11px;
    color: #00695c;  /* Dark teal */
    font-weight: 600;
    background: rgba(255, 255, 255, 0.9);
    padding: 2px 6px;
    border-radius: 4px;
    z-index: 10;
}

        .user-message {
            background: var(--brand-color, #8B5CF6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            margin-top: 25px;
        }

        .system-message {
    background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);  /* Light teal gradient */
    border: 1px solid #00D3C9;  /* Your teal border */
    color: #00695c;  /* Dark teal text for contrast */
    align-self: center;
    max-width: 90%;
    text-align: center;
    font-size: 14px;
    border-radius: 20px;
    padding: 12px 16px;
    margin: 20px 0;  /* More spacing */
    margin-top: 35px;  /* Ensure it doesn't overlap */
    font-weight: 600;
    animation: systemMessageAppear 0.5s ease-out;
    box-shadow: 0 2px 4px rgba(0, 211, 201, 0.2);  /* Teal shadow */
}

        @keyframes systemMessageAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .quick-reply {
            padding: 8px 14px;
            border: 1px solid var(--brand-color, #8B5CF6);
            border-radius: 18px;
            background: white;
            color: var(--brand-color, #8B5CF6);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-reply:hover {
            background: var(--brand-color, #8B5CF6);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--brand-color, #8B5CF6);
        }

        .send-button {
            padding: 12px 20px;
            background: var(--brand-color, #8B5CF6);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .send-button:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 16px;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .typing-indicator.operator-typing {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .typing-indicator.operator-typing::before {
            content: "üë®‚Äçüíº Team member is typing...";
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 11px;
            color: #059669;
            font-weight: 600;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        .loading-message {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--brand-color, #8B5CF6);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contact-form {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid var(--brand-color, #8B5CF6);
            border-radius: 16px;
            padding: 24px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .contact-form h4 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .contact-form p {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 18px;
            line-height: 1.5;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 18px;
        }

        .contact-form input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .contact-form input:focus {
            border-color: var(--brand-color, #8B5CF6);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 12px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .submit-btn {
            background: var(--brand-color, #8B5CF6);
            color: white;
        }

        .submit-btn:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .skip-btn {
            background: transparent;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .skip-btn:hover {
            border-color: #d1d5db;
            color: #4b5563;
            background: #f9fafb;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 12px;
            line-height: 1.4;
        }

        .business-info {
            background: linear-gradient(135deg, var(--brand-color, #8B5CF6), var(--brand-color-dark, #7C3AED));
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .business-info h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .business-info p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 95%;
                font-size: 16px;
                margin-top: 30px;
            }
            
            .message::before {
                font-size: 10px;
                top: -20px;
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .quick-replies {
                gap: 4px;
            }
            
            .quick-reply {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .system-message {
                font-size: 13px;
                max-width: 95%;
                margin: 20px 0;
            }
        }

        .message a {
            color: inherit;
            text-decoration: underline;
            text-decoration-color: rgba(255,255,255,0.5);
        }

        .bot-message a {
            color: var(--brand-color, #8B5CF6);
            text-decoration-color: var(--brand-color, #8B5CF6);
        }

        .operator-message a {
            color: white;
            text-decoration-color: rgba(255,255,255,0.7);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-messages" id="chatMessages">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            Loading chat...
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="chat-input-container">
        <input 
            type="text" 
            class="chat-input" 
            id="chatInput" 
            placeholder="Type your question..."
            onkeypress="handleKeyPress(event)"
            disabled
        >
        <button class="send-button" id="sendButton" onclick="sendMessage(event)" disabled>Send</button>
    </div>

    <script>
        console.log('=== ENHANCED CHAT DEBUG START ===');
        console.log('URL:', window.location.href);
        console.log('URL params:', window.location.search);

        // REPLACE with this improved version:

let operatorId = null;
let businessConfig = null;
let serverUrl = 'https://wherewolf-chatbot.onrender.com';
let isFirstMessage = true;
let hasProvidedContact = false;
let pendingMessage = null;
let pollingInterval = null;
let lastMessageCount = 0;

// üîß FIXED: Add sessionId initialization
let sessionId = null;

// Get operator ID from URL
const urlParams = new URLSearchParams(window.location.search);
operatorId = urlParams.get('operator');

// üîß FIXED: Initialize sessionId properly  
const urlSessionId = urlParams.get('session');
if (urlSessionId) {
    sessionId = urlSessionId;
    console.log('üîó Using session from URL:', sessionId);
} else {
    // Check for existing session
    let existingSession = sessionStorage.getItem('wherewolf_session_id');
    let sessionAge = sessionStorage.getItem('wherewolf_session_age');
    
    // Check if session is too old (older than 4 hours = stale)
    const FOUR_HOURS = 4 * 60 * 60 * 1000;
    const now = Date.now();
    
    if (existingSession && sessionAge && (now - parseInt(sessionAge)) < FOUR_HOURS) {
        // Use existing session (less than 4 hours old)
        sessionId = existingSession;
        console.log('üîÑ Using existing session:', sessionId);
    } else {
        // Create fresh session
        sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        sessionStorage.setItem('wherewolf_session_id', sessionId);
        sessionStorage.setItem('wherewolf_session_age', now.toString());
        console.log('üÜï Created new session:', sessionId);
    }
}

console.log('Operator ID from URL:', operatorId);
console.log('Server URL:', serverUrl);

if (!operatorId) {
    console.error('‚ùå No operator ID provided in URL');
    showError('Error: No operator ID provided');
} else {
    console.log('‚úÖ Starting chat initialization...');
    loadOperatorConfig();
}
        // üÜï FIXED: Add missing handleKeyPress function
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        // üÜï FIXED: Add missing showTyping function
        function showTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';
            typingIndicator.classList.remove('operator-typing'); // Regular bot typing
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Enhanced config loading with debugging
        async function loadOperatorConfig() {
    try {
        console.log('üîç Loading config for operator:', operatorId);
        
        const configUrl = `${serverUrl}/api/config/${operatorId}`;
        console.log('üì° Fetching from:', configUrl);
        
        const response = await fetch(configUrl);
        console.log('üì® Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Config fetch failed:', errorText);
            throw new Error(`Config not found (${response.status}): ${errorText}`);
        }
        
        businessConfig = await response.json();
        console.log('‚úÖ Config loaded successfully:', businessConfig);
        
        applyBranding(businessConfig);
        
        // üîß FIXED: Load history FIRST, then decide what to show
        const hasHistory = await loadConversationHistory();
        
        if (!hasHistory) {
            // Only show welcome for NEW conversations
            console.log('üí¨ New conversation - showing welcome');
            initializeEnhancedChat();
        } else {
            // Just enable the input for existing conversations
            console.log('üîÑ Existing conversation - enabling input only');
            enableChatInput();
        }
        
        console.log('üéâ Chat initialization complete!');
        
    } catch (error) {
        console.error('üí• Config loading error:', error);
        showError(`Error loading chat: ${error.message}. Please check the operator ID and try again.`);
    }
}
// Enable chat input without showing welcome message
function enableChatInput() {
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    chatInput.disabled = false;
    sendButton.disabled = false;
    chatInput.placeholder = "Type your question...";
    chatInput.focus();
    
    console.log('üí¨ Chat input enabled for existing conversation');
}

        // 2. REPLACE the loadConversationHistory function with this improved version:
        // üß™ DEBUG: Add this function to test what's happening
function debugSessionState() {
    console.log('üß™ === SESSION DEBUG ===');
    console.log('Current sessionId:', sessionId);
    console.log('SessionStorage sessionId:', sessionStorage.getItem('wherewolf_session_id'));
    console.log('SessionStorage age:', sessionStorage.getItem('wherewolf_session_age'));
    console.log('hasProvidedContact:', hasProvidedContact);
    console.log('isFirstMessage:', isFirstMessage);
    console.log('operatorId:', operatorId);
    
    // Test if session age is too old
    const sessionAge = sessionStorage.getItem('wherewolf_session_age');
    const FOUR_HOURS = 4 * 60 * 60 * 1000;
    const now = Date.now();
    const ageInMinutes = sessionAge ? Math.round((now - parseInt(sessionAge)) / 60000) : 'N/A';
    console.log('Session age (minutes):', ageInMinutes);
    console.log('Session expired?', sessionAge ? (now - parseInt(sessionAge)) >= FOUR_HOURS : 'N/A');
    
    console.log('üß™ === END SESSION DEBUG ===');
}

        async function loadConversationHistory() {
    try {
        console.log('üìú Loading conversation history for session:', sessionId);
        
        const response = await fetch(`${serverUrl}/api/chat/history`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                operatorId: operatorId,
                sessionId: sessionId
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('üìú History response:', data);
            
            if (data.messages && data.messages.length > 0) {
                console.log(`üìö Found ${data.messages.length} previous messages - restoring conversation`);
                
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';
                
                data.messages.forEach((msg, index) => {
                    displayMessage(msg.content, msg.role);
                });
                
                const userMessages = data.messages.filter(msg => msg.role === 'user');
                if (userMessages.length > 0) {
                    hasProvidedContact = true;
                    isFirstMessage = false;
                    console.log('‚úÖ Found user messages - contact info was provided previously');
                }
                
                if (data.hasOperator || data.agentRequested) {
                    console.log('üîÑ Previous operator involvement detected, starting polling...');
                    startOperatorMessagePolling();
                }
                
                lastMessageCount = data.messages.length;
                return true; // ‚úÖ History found
            } else {
                console.log('üì≠ No previous messages found - this is a fresh conversation');
                hasProvidedContact = false;
                isFirstMessage = true;
                return false; // ‚úÖ No history
            }
        } else {
            console.log('‚ö†Ô∏è Could not load history - treating as new conversation');
            hasProvidedContact = false;
            isFirstMessage = true;
            return false; // ‚úÖ No history
        }
    } catch (error) {
        console.error('‚ùå Error loading conversation history:', error);
        hasProvidedContact = false;
        isFirstMessage = true;
        return false; // ‚úÖ No history
    }
}
function forceNewSession() {
    console.log('üîÑ Forcing completely new session...');
    
    // Clear any existing session data
    sessionStorage.removeItem('wherewolf_session_id');
    sessionStorage.removeItem('wherewolf_session_age');
    
    // Generate new session
    sessionId = 'chat_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
    sessionStorage.setItem('wherewolf_session_id', sessionId);
    sessionStorage.setItem('wherewolf_session_age', Date.now().toString());
    
    // Reset chat state
    isFirstMessage = true;
    hasProvidedContact = false;
    pendingMessage = null;
    lastMessageCount = 0;
    
    // Clear chat UI
    const messagesContainer = document.getElementById('chatMessages');
    if (messagesContainer) {
        messagesContainer.innerHTML = '<div class="loading-message"><div class="loading-spinner"></div>Loading chat...</div>';
    }
    
    // Restart initialization
    if (operatorId && businessConfig) {
        initializeEnhancedChat();
    }
    
    console.log('‚úÖ New session created:', sessionId);
}

        // Apply branding from config
        function applyBranding(config) {
    const brandColor = config.brandColor || '#7722A5';  /* ‚Üê Your purple */
    const brandColorDark = darkenColor(brandColor, 15);
    
    document.documentElement.style.setProperty('--brand-color', brandColor);
    document.documentElement.style.setProperty('--brand-color-dark', brandColorDark);
    
    console.log('üé® Applied branding:', brandColor);
}

        // Helper function to darken colors
        function darkenColor(hex, percent = 15) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // Initialize enhanced chat interface
        function initializeEnhancedChat() {
            const businessName = businessConfig.businessName || 'our business';
            const businessType = businessConfig.businessType || 'tours';
            const companyTagline = businessConfig.companyTagline || '';
            const customGreeting = businessConfig.customGreeting || '';
            
            let welcomeMessage;
            if (customGreeting && customGreeting.trim() && customGreeting !== 'Hi! Welcome to [Business Name]. I\'m here to help you plan your perfect adventure!') {
                welcomeMessage = customGreeting.replace(/\[Business Name\]/g, businessName);
            } else {
                let businessDisplayName = businessName;
                
                if (companyTagline && 
                    companyTagline.length < 50 && 
                    !companyTagline.toLowerCase().includes('live, laugh, love') &&
                    companyTagline.trim() !== businessName) {
                    businessDisplayName = `${businessName} - ${companyTagline}`;
                }
                
                welcomeMessage = `üëã Hi! Welcome to ${businessDisplayName}. I'm here to help with your ${businessType} questions. What would you like to know?`;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            
            if (messagesContainer.querySelector('.loading-message')) {
                messagesContainer.innerHTML = '';

                if (businessConfig.websiteUrl || businessConfig.phoneNumber || businessConfig.businessHours) {
                    const businessInfoHtml = `
                        <div class="message bot-message">
                            <div class="business-info">
                                <h4>${businessName}</h4>
                                <p>${companyTagline && companyTagline !== businessName ? companyTagline : `Your trusted ${businessType} provider`}</p>
                            </div>
                        </div>
                    `;
                    messagesContainer.insertAdjacentHTML('beforeend', businessInfoHtml);
                }

                const welcomeHtml = `
                    <div class="message bot-message">
                        <div>${welcomeMessage}</div>
                        <div class="quick-replies">
                            <button class="quick-reply" onclick="sendQuickReply('What are your tour times?')">üïí Tour Times</button>
                            <button class="quick-reply" onclick="sendQuickReply('How much does it cost?')">üí∞ Pricing</button>
                            <button class="quick-reply" onclick="sendQuickReply('Where do I meet you?')">üìç Location</button>
                            <button class="quick-reply" onclick="sendQuickReply('What should I bring?')">üéí What to Bring</button>
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', welcomeHtml);
            }

            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.placeholder = "Type your question...";
            chatInput.focus();
            
            console.log('üí¨ Chat interface ready!');
        }

        function showError(message) {
            console.error('Showing error:', message);
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Chat Loading Error</h3>
                    <p>${message}</p>
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                        <strong>Debug Info:</strong><br>
                        Operator ID: ${operatorId || 'Not provided'}<br>
                        URL: ${window.location.href}
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="/setup" style="color: #8B5CF6; text-decoration: underline;">‚Üê Go to Setup</a>
                    </div>
                </div>
            `;
        }

        async function sendMessage(event) {
    // Add event parameter and prevent default
    if (event) {
        event.preventDefault();
    }
    
    const input = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const message = input.value.trim();
    
    if (!message) return;
    
    input.disabled = true;
    sendButton.disabled = true;
    
    displayMessage(message, 'user');
    input.value = '';
    
    await sendMessageToServer(message);
    
    input.disabled = false;
    sendButton.disabled = false;
    input.focus();
}

        // üîß FIXED: Updated showContactForm function
function showContactForm() {
    const businessName = businessConfig.businessName || 'our business';
    const smsEnabled = businessConfig.smsEnabled || 'disabled';
    
    let formContent = '';
    
    if (smsEnabled === 'sms-first') {
        formContent = `
            <h4>üì± Let's connect via text!</h4>
            <p>What's your mobile number? We'll send you a quick text so you can chat with us on the go.</p>
            <div class="form-row">
                <input 
                    type="tel" 
                    id="contactPhone" 
                    placeholder="+1 (555) 123-4567" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                    style="font-size: 16px;"
                >
                <input 
                    type="email" 
                    id="contactEmail" 
                    placeholder="Email (optional)" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
            </div>
            <div class="form-buttons">
                <button class="submit-btn" onclick="submitContact()">Send SMS ‚Üí</button>
                <button class="skip-btn" onclick="skipContact()">Continue here instead</button>
            </div>
            <p class="help-text">We'll send you a text message to start the conversation on your mobile device</p>
        `;
    } else {
        // üîß FIXED: Removed response time text
        formContent = `
            <h4>üëã Quick question first!</h4>
            <p>Could we get your email so we can send you ${businessConfig.businessType || 'tour'} info and follow up if needed?</p>
            <div class="form-row">
                <input 
                    type="email" 
                    id="contactEmail" 
                    placeholder="your@email.com" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
                <input 
                    type="tel" 
                    id="contactPhone" 
                    placeholder="Phone (optional)" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
            </div>
            <div class="form-buttons">
                <button class="submit-btn" onclick="submitContact()">Continue ‚Üí</button>
                <button class="skip-btn" onclick="skipContact()">Skip for now</button>
            </div>
            <p class="help-text">We'll use this to send you ${businessConfig.businessType || 'tour'} details and follow up if you have questions later</p>
        `;
    }
    
    const contactFormHtml = `
        <div class="message bot-message">
            <div class="contact-form">
                ${formContent}
            </div>
        </div>
    `;
    
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.insertAdjacentHTML('beforeend', contactFormHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    setTimeout(() => {
        if (smsEnabled === 'sms-first') {
            document.getElementById('contactPhone').focus();
        } else {
            document.getElementById('contactEmail').focus();
        }
    }, 100);
}


        // Enhanced submitContact function with detailed error logging
async function submitContact() {
    const email = document.getElementById('contactEmail').value;
    const phone = document.getElementById('contactPhone').value;
    const smsEnabled = businessConfig.smsEnabled || 'disabled';
    
    console.log('üîç CONTACT FORM DEBUG:');
    console.log('  - Email:', email);
    console.log('  - Phone:', phone);
    console.log('  - SMS Mode:', smsEnabled);
    console.log('  - Operator ID:', operatorId);
    console.log('  - Server URL:', serverUrl);
    
    // Enhanced validation with specific error messages
    if (smsEnabled === 'sms-first') {
        const phoneRegex = /^\+?[\s\-\(\)]*([0-9][\s\-\(\)]*){10,}$/;
        if (!phone || !phoneRegex.test(phone)) {
            const phoneInput = document.getElementById('contactPhone');
            phoneInput.style.borderColor = '#EF4444';
            phoneInput.placeholder = 'Please enter a valid phone number';
            phoneInput.value = '';
            phoneInput.focus();
            console.error('‚ùå Phone validation failed:', phone);
            return;
        }
    } else {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            const emailInput = document.getElementById('contactEmail');
            emailInput.style.borderColor = '#EF4444';
            emailInput.placeholder = 'Please enter a valid email';
            emailInput.value = '';
            emailInput.focus();
            console.error('‚ùå Email validation failed:', email);
            return;
        }
    }
    
    hasProvidedContact = true;
    
    try {
        console.log('üì§ Sending contact info to server...');
        
        const requestBody = { 
            email, 
            phone, 
            operatorId: operatorId,
            sessionId: sessionId
        };
        
        console.log('üìã Request body:', requestBody);
        
        const response = await fetch(`${serverUrl}/contact-info`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Server error response:', errorText);
            throw new Error(`Server error ${response.status}: ${errorText}`);
        }
        
        const responseData = await response.json();
        console.log('‚úÖ Server response:', responseData);
        
        if (!responseData.success) {
            throw new Error(responseData.error || 'Server returned success: false');
        }
        
        console.log('üìß Contact info saved successfully!');
        
        const lastMessage = document.querySelector('.message:last-child');
        let successMessage = '';
        
        if (smsEnabled === 'sms-first') {
            successMessage = '‚ú® Perfect! Now let me help you with your question, and we\'ll send you a text shortly...';
        } else {
            successMessage = '‚ú® Perfect! Now let me help you with your question...';
        }
        
        lastMessage.innerHTML = `
            <div style="
                color: #059669; 
                font-weight: 600; 
                font-size: 14px;
                text-align: center;
                padding: 16px;
                background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                border-radius: 12px;
                border: 1px solid #a7f3d0;
            ">
                ${successMessage}
            </div>
        `;
        
        // Send the pending message after a delay
        setTimeout(async () => {
            if (pendingMessage) {
                console.log('üì§ Now sending pending message:', pendingMessage);
                await sendMessageToServer(pendingMessage);
                pendingMessage = null;
            }
        }, 1500);
        
    } catch (error) {
        console.error('üí• CONTACT SAVE ERROR:', error);
        console.error('  - Error message:', error.message);
        console.error('  - Error stack:', error.stack);
        
        // Show user-friendly error message
        const lastMessage = document.querySelector('.message:last-child');
        if (lastMessage) {
            lastMessage.innerHTML = `
                <div style="
                    color: #dc2626; 
                    font-weight: 600; 
                    font-size: 14px;
                    text-align: center;
                    padding: 16px;
                    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
                    border-radius: 12px;
                    border: 1px solid #f87171;
                ">
                    ‚ùå Failed to save contact info. Error: ${error.message}
                    <br><br>
                    <button onclick="skipContact()" style="
                        background: #8B5CF6; 
                        color: white; 
                        border: none; 
                        padding: 8px 16px; 
                        border-radius: 6px; 
                        cursor: pointer;
                    ">Continue anyway</button>
                </div>
            `;
        }
        
        // Don't call skipContact() automatically - let user decide
    }
}

// üîß FIXED: Updated skipContact function
function skipContact() {
    hasProvidedContact = true;
    const lastMessage = document.querySelector('.message:last-child');
    lastMessage.remove();
    
    // Send the pending message immediately
    if (pendingMessage) {
        console.log('üì§ Sending pending message after skip:', pendingMessage);
        sendMessageToServer(pendingMessage);
        pendingMessage = null;
    }
}

       // 1. REPLACE the sendMessageToServer function in chat.html with this fixed version:
async function sendMessageToServer(message) {
    showTyping();
    
    try {
        console.log('üì§ Sending message:', message, 'Session:', sessionId);
        console.log('üîç Contact info status:', { hasProvidedContact, isFirstMessage });
        
        const response = await fetch(`${serverUrl}/api/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                message: message,
                operatorId: operatorId,
                sessionId: sessionId  // Use proper sessionId
            })
        });
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì® Server response:', data);
        hideTyping();
        
        // üîß FIXED: Handle contact form request BEFORE answering question
        if (data.showContactForm && !hasProvidedContact) {
            console.log('üìù Server requesting contact form before answering');
            pendingMessage = data.pendingMessage || message;
            showContactForm();
            return; // Don't show any response yet
        }
        
        // üîß FIXED: If this was the first message and no contact form, mark as no longer first
        if (isFirstMessage) {
            isFirstMessage = false;
            console.log('‚úÖ First message processed');
        }
        
        if (data.skipBotResponse) {
            console.log('üí¨ Operator is active - no bot response needed');
            return;
        }
        
        if (data.operatorJoined) {
            displayMessage('üë®‚Äçüíº A team member has joined the chat to assist you personally!', 'system');
        }
        
        if (data.response) {
            displayMessage(data.response, data.fromOperator ? 'operator' : 'bot');
            
            // Execute any JavaScript that might be in the response!
            setTimeout(() => {
                const scripts = document.querySelectorAll('.bot-message script');
                scripts.forEach(script => {
                    try {
                        eval(script.innerHTML);
                    } catch (e) {
                        console.log('Script execution skipped:', e);
                    }
                });
            }, 100);
        }
        
        if (data.agentRequested || data.operatorJoined || data.startPolling || data.twoWayChat || data.continuePolling) {
            console.log('üîÑ Starting/continuing message polling...');
            startOperatorMessagePolling();
            
            if (data.smsEnabled && data.smsMode === 'hybrid') {
                setTimeout(() => {
                    showSMSNotification('üí¨ Choose your preferred way to continue the conversation!', '#8B5CF6');
                }, 2000);
            } else if (data.smsEnabled && data.smsMode === 'sms-first') {
                setTimeout(() => {
                    showSMSNotification('üì± SMS conversation starting!', '#10b981');
                }, 2000);
            } else if (data.twoWayChat) {
                setTimeout(() => {
                    showSMSNotification('üí¨ Two-way chat active - team member will respond here!', '#8B5CF6');
                }, 2000);
            } else if (data.agentRequested) {
                setTimeout(() => {
                    showSMSNotification('üë®‚Äçüíº Team member will contact you soon...', '#10b981');
                }, 2000);
            }
        }
        
    } catch (error) {
        console.error('üí• Chat error:', error);
        hideTyping();
        displayMessage('Sorry, I\'m having connection issues. Please try again or contact us directly.', 'bot');
    }
}

        function showSMSNotification(message, color = '#8B5CF6') {
            const existing = document.getElementById('sms-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'sms-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, ${color}, ${darkenColor(color, 15)});
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10002;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                max-width: 350px;
                animation: slideInRight 0.5s ease-out;
                cursor: pointer;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div>${message}</div>
                    <div style="margin-left: auto; opacity: 0.7; font-size: 18px;">√ó</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 8000);
            
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            });
        }

        function sendQuickReply(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        function displayMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let messageClass = `message ${sender}-message`;
            let displayText = text;
            
            if (sender === 'operator') {
                messageClass = 'message operator-message';
                
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBkCU2fPFdSYELYDN8+OLOgcZZ7zq559NEAxQp+PwtmUeBC+Gzs/kgCECHm224+KEQQE');
                    audio.volume = 0.1;
                    audio.play().catch(() => {});
                } catch (e) {
                    // Ignore audio errors
                }
            } else if (sender === 'system') {
                messageClass = 'message system-message';
            }
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = displayText;
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function startOperatorMessagePolling() {
    if (pollingInterval) {
        console.log('üîÑ Polling already active, skipping...');
        return;
    }
    
    console.log('üîÑ Starting enhanced operator message polling...');
    console.log('üìç Using sessionId:', sessionId); // Debug log
    
    let consecutiveErrors = 0;
    let pollCount = 0;
    
    pollingInterval = setInterval(async () => {
        try {
            pollCount++;
            console.log(`üì° Polling attempt #${pollCount} (sessionId: ${sessionId}, lastMessageCount: ${lastMessageCount})`);
            
            const response = await fetch(`${serverUrl}/api/chat/poll-messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    operatorId: operatorId,
                    sessionId: sessionId,  // ‚Üê USE THE ACTUAL sessionId!
                    lastMessageCount: lastMessageCount
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üì¨ Poll response:', data);
            
            if (data.success && data.newMessages && data.newMessages.length > 0) {
                console.log(`üì• Received ${data.newMessages.length} new messages`);
                
                data.newMessages.forEach(msg => {
                    console.log('üì® Processing message:', msg);
                    
                    if (msg.role === 'operator') {
                        displayMessage(msg.content, 'operator');
                        
                        if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                            new Notification('Team Member Responded!', {
                                body: msg.content.substring(0, 100),
                                icon: '/favicon.ico'
                            });
                        }
                        
                        const typingIndicator = document.getElementById('typingIndicator');
                        if (typingIndicator.classList.contains('operator-typing')) {
                            hideTyping();
                        }
                        
                    } else if (msg.role === 'system') {
                        displayMessage(msg.content, 'system');
                    }
                });
                
                lastMessageCount = data.totalMessages || (lastMessageCount + data.newMessages.length);
                consecutiveErrors = 0;
            }
            
            if (data.operatorTyping) {
                showOperatorTyping();
            }
            
        } catch (error) {
            consecutiveErrors++;
            console.error(`‚ùå Polling error #${consecutiveErrors}:`, error);
            
            if (consecutiveErrors >= 3) {
                console.log('üîÑ Too many errors, restarting polling...');
                clearInterval(pollingInterval);
                pollingInterval = null;
                
                const backoffTime = Math.min(1000 * Math.pow(2, consecutiveErrors - 3), 30000);
                setTimeout(() => {
                    if (!pollingInterval) {
                        startOperatorMessagePolling();
                    }
                }, backoffTime);
                return;
            }
        }
    }, 1000);
}

        function showOperatorTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';
            typingIndicator.classList.add('operator-typing');
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                if (typingIndicator.classList.contains('operator-typing')) {
                    hideTyping();
                }
            }, 5000);
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'none';
            typingIndicator.classList.remove('operator-typing');
        }

        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && lastMessageCount > 0 && !pollingInterval) {
                startOperatorMessagePolling();
            }
        });

        window.addEventListener('resize', function() {
            const chatInput = document.getElementById('chatInput');
            if (window.innerWidth <= 768) {
                chatInput.style.fontSize = '16px';
            }
        });

        setInterval(() => {
            if (pollingInterval) {
                fetch(`${serverUrl}/api/test`, { method: 'HEAD' }).catch(() => {});
            }
        }, 30000);

        // MISSING FUNCTIONS for hybrid chat buttons
window.selectChatChoice = function(choice) {
    console.log('Choice selected:', choice);
    
    // Disable buttons to prevent double-clicks
    document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    });
    
    if (choice === 'sms') {
        // Show phone number collection
        showPhoneCollection();
    } else if (choice === 'use-existing-phone') {
        // Use existing phone number for SMS
        sendMessageToServer('Please use my existing phone number for SMS');
    } else {
        // Continue with regular chat handoff
        sendMessageToServer('I prefer to continue chatting here');
    }
};

window.showPhoneCollection = function() {
    // Find the button container and replace it with phone input
    const choiceContainer = document.querySelector('.choice-btn').closest('div');
    if (choiceContainer) {
        choiceContainer.innerHTML = `
            <div style="text-align: center; margin: 15px 0;">
                <h4 style="margin: 0 0 12px 0; color: #1f2937;">üì± What's your mobile number?</h4>
                <input type="tel" id="hybridPhoneInput" placeholder="+1 (555) 123-4567" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 16px;
                    margin-bottom: 12px;
                " onkeypress="if(event.key==='Enter') submitHybridPhone()">
                <button onclick="submitHybridPhone()" style="
                    width: 100%;
                    padding: 12px;
                    background: #8B5CF6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">Send me a text! üì±</button>
            </div>
        `;
        
        // Focus on the phone input
        setTimeout(() => {
            const phoneInput = document.getElementById('hybridPhoneInput');
            if (phoneInput) {
                phoneInput.focus();
            }
        }, 100);
    }
};

window.submitHybridPhone = function() {
    const phoneInput = document.getElementById('hybridPhoneInput');
    if (!phoneInput) {
        console.error('Phone input not found');
        return;
    }
    
    const phone = phoneInput.value.trim();
    
    if (!phone) {
        phoneInput.style.borderColor = '#ef4444';
        phoneInput.placeholder = 'Please enter your phone number';
        phoneInput.focus();
        return;
    }
    
    // Validate phone number format
    const phoneRegex = /^\+?[\s\-\(\)]*([0-9][\s\-\(\)]*){10,}$/;
    if (!phoneRegex.test(phone)) {
        phoneInput.style.borderColor = '#ef4444';
        phoneInput.placeholder = 'Please enter a valid phone number';
        phoneInput.value = '';
        phoneInput.focus();
        return;
    }
    
    // Send the phone number as a message
    console.log('Submitting phone number:', phone);
    sendMessageToServer(phone);
};

// Also add this helper function for debugging
window.sendMessageToServer = window.sendMessageToServer || sendMessageToServer;

        console.log('üéâ Enhanced chat script loaded successfully!');
    </script>
</body>
</html>