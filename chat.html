<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            animation: messageSlide 0.3s ease-out;
            margin-top: 25px;
            position: relative;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            background: #f3f4f6;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .bot-message::before {
            content: "ü§ñ Chatbot";
            position: absolute;
            top: -22px;
            left: 0;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .operator-message {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #047857;
            position: relative;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .operator-message::before {
            content: "üë®‚Äçüíº Team Member";
            position: absolute;
            top: -22px;
            left: 0;
            font-size: 11px;
            color: #6b7280;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 10;
        }

        .user-message {
            background: var(--brand-color, #8B5CF6);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            margin-top: 25px;
        }

        .system-message {
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 1px solid #f59e0b;
            color: #92400e;
            align-self: center;
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            border-radius: 20px;
            padding: 12px 16px;
            margin: 15px 0;
            font-weight: 600;
            animation: systemMessageAppear 0.5s ease-out;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.2);
        }

        @keyframes systemMessageAppear {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .quick-reply {
            padding: 8px 14px;
            border: 1px solid var(--brand-color, #8B5CF6);
            border-radius: 18px;
            background: white;
            color: var(--brand-color, #8B5CF6);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-reply:hover {
            background: var(--brand-color, #8B5CF6);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-input-container {
            padding: 16px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: var(--brand-color, #8B5CF6);
        }

        .send-button {
            padding: 12px 20px;
            background: var(--brand-color, #8B5CF6);
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 60px;
        }

        .send-button:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 16px;
            border-bottom-left-radius: 6px;
            border: 1px solid #e5e7eb;
            position: relative;
        }

        .typing-indicator.operator-typing {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .typing-indicator.operator-typing::before {
            content: "üë®‚Äçüíº Team member is typing...";
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 11px;
            color: #059669;
            font-weight: 600;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #9ca3af;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        .loading-message {
            text-align: center;
            color: #6b7280;
            padding: 40px 20px;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--brand-color, #8B5CF6);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contact-form {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid var(--brand-color, #8B5CF6);
            border-radius: 16px;
            padding: 24px;
            margin: 10px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .contact-form h4 {
            color: #1f2937;
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
        }

        .contact-form p {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 18px;
            line-height: 1.5;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 18px;
        }

        .contact-form input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .contact-form input:focus {
            border-color: var(--brand-color, #8B5CF6);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 12px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .submit-btn {
            background: var(--brand-color, #8B5CF6);
            color: white;
        }

        .submit-btn:hover {
            background: var(--brand-color-dark, #7C3AED);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .skip-btn {
            background: transparent;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .skip-btn:hover {
            border-color: #d1d5db;
            color: #4b5563;
            background: #f9fafb;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
            margin-top: 12px;
            line-height: 1.4;
        }

        .business-info {
            background: linear-gradient(135deg, var(--brand-color, #8B5CF6), var(--brand-color-dark, #7C3AED));
            color: white;
            padding: 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .business-info h4 {
            margin: 0 0 8px 0;
            font-size: 16px;
        }

        .business-info p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .message {
                max-width: 95%;
                font-size: 16px;
                margin-top: 30px;
            }
            
            .message::before {
                font-size: 10px;
                top: -20px;
            }
            
            .chat-input-container {
                padding: 12px;
            }
            
            .quick-replies {
                gap: 4px;
            }
            
            .quick-reply {
                font-size: 14px;
                padding: 10px 16px;
            }
            
            .system-message {
                font-size: 13px;
                max-width: 95%;
                margin: 20px 0;
            }
        }

        .message a {
            color: inherit;
            text-decoration: underline;
            text-decoration-color: rgba(255,255,255,0.5);
        }

        .bot-message a {
            color: var(--brand-color, #8B5CF6);
            text-decoration-color: var(--brand-color, #8B5CF6);
        }

        .operator-message a {
            color: white;
            text-decoration-color: rgba(255,255,255,0.7);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-messages" id="chatMessages">
        <div class="loading-message">
            <div class="loading-spinner"></div>
            Loading chat...
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
    
    <div class="chat-input-container">
        <input 
            type="text" 
            class="chat-input" 
            id="chatInput" 
            placeholder="Type your question..."
            onkeypress="handleKeyPress(event)"
            disabled
        >
        <button class="send-button" id="sendButton" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script>
        console.log('=== ENHANCED CHAT DEBUG START ===');
        console.log('URL:', window.location.href);
        console.log('URL params:', window.location.search);

        let operatorId = null;
        let businessConfig = null;
        let serverUrl = 'https://wherewolf-chatbot.onrender.com';
        let isFirstMessage = true;
        let hasProvidedContact = false;
        let pendingMessage = null;
        let pollingInterval = null;
        let lastMessageCount = 0;

        // Get operator ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        operatorId = urlParams.get('operator');

        console.log('Operator ID from URL:', operatorId);
        console.log('Server URL:', serverUrl);

        if (!operatorId) {
            console.error('‚ùå No operator ID provided in URL');
            showError('Error: No operator ID provided');
        } else {
            console.log('‚úÖ Starting chat initialization...');
            loadOperatorConfig();
        }

        // üÜï FIXED: Add missing handleKeyPress function
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        }

        // üÜï FIXED: Add missing showTyping function
        function showTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';
            typingIndicator.classList.remove('operator-typing'); // Regular bot typing
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Enhanced config loading with debugging
        async function loadOperatorConfig() {
            try {
                console.log('üîç Loading config for operator:', operatorId);
                
                const configUrl = `${serverUrl}/api/config/${operatorId}`;
                console.log('üì° Fetching from:', configUrl);
                
                const response = await fetch(configUrl);
                console.log('üì® Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Config fetch failed:', errorText);
                    throw new Error(`Config not found (${response.status}): ${errorText}`);
                }
                
                businessConfig = await response.json();
                console.log('‚úÖ Config loaded successfully:', businessConfig);
                
                applyBranding(businessConfig);
                initializeEnhancedChat();
                loadConversationHistory();
                
                console.log('üéâ Chat initialization complete!');
                
            } catch (error) {
                console.error('üí• Config loading error:', error);
                showError(`Error loading chat: ${error.message}. Please check the operator ID and try again.`);
            }
        }

        // Load conversation history when chat loads
        async function loadConversationHistory() {
            try {
                const response = await fetch(`${serverUrl}/api/chat/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        operatorId: operatorId,
                        sessionId: 'default'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.messages && data.messages.length > 0) {
                        const messagesContainer = document.getElementById('chatMessages');
                        messagesContainer.innerHTML = '';
                        
                        data.messages.forEach(msg => {
                            displayMessage(msg.content, msg.role);
                        });
                        
                        if (data.hasOperator || data.agentRequested) {
                            console.log('üîÑ Previous operator involvement detected, starting polling...');
                            startOperatorMessagePolling();
                            isFirstMessage = false;
                        }
                        
                        lastMessageCount = data.messages.length;
                    }
                }
            } catch (error) {
                console.error('Error loading conversation history:', error);
            }
        }

        // Apply branding from config
        function applyBranding(config) {
            const brandColor = config.brandColor || '#8B5CF6';
            const brandColorDark = darkenColor(brandColor, 15);
            
            document.documentElement.style.setProperty('--brand-color', brandColor);
            document.documentElement.style.setProperty('--brand-color-dark', brandColorDark);
            
            console.log('üé® Applied branding:', brandColor);
        }

        // Helper function to darken colors
        function darkenColor(hex, percent = 15) {
            const num = parseInt(hex.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }

        // Initialize enhanced chat interface
        function initializeEnhancedChat() {
            const businessName = businessConfig.businessName || 'our business';
            const businessType = businessConfig.businessType || 'tours';
            const companyTagline = businessConfig.companyTagline || '';
            const customGreeting = businessConfig.customGreeting || '';
            
            let welcomeMessage;
            if (customGreeting && customGreeting.trim() && customGreeting !== 'Hi! Welcome to [Business Name]. I\'m here to help you plan your perfect adventure!') {
                welcomeMessage = customGreeting.replace(/\[Business Name\]/g, businessName);
            } else {
                let businessDisplayName = businessName;
                
                if (companyTagline && 
                    companyTagline.length < 50 && 
                    !companyTagline.toLowerCase().includes('live, laugh, love') &&
                    companyTagline.trim() !== businessName) {
                    businessDisplayName = `${businessName} - ${companyTagline}`;
                }
                
                welcomeMessage = `üëã Hi! Welcome to ${businessDisplayName}. I'm here to help with your ${businessType} questions. What would you like to know?`;
            }
            
            const messagesContainer = document.getElementById('chatMessages');
            
            if (messagesContainer.querySelector('.loading-message')) {
                messagesContainer.innerHTML = '';

                if (businessConfig.websiteUrl || businessConfig.phoneNumber || businessConfig.businessHours) {
                    const businessInfoHtml = `
                        <div class="message bot-message">
                            <div class="business-info">
                                <h4>${businessName}</h4>
                                <p>${companyTagline && companyTagline !== businessName ? companyTagline : `Your trusted ${businessType} provider`}</p>
                            </div>
                        </div>
                    `;
                    messagesContainer.insertAdjacentHTML('beforeend', businessInfoHtml);
                }

                const welcomeHtml = `
                    <div class="message bot-message">
                        <div>${welcomeMessage}</div>
                        <div class="quick-replies">
                            <button class="quick-reply" onclick="sendQuickReply('What are your tour times?')">üïí Tour Times</button>
                            <button class="quick-reply" onclick="sendQuickReply('How much does it cost?')">üí∞ Pricing</button>
                            <button class="quick-reply" onclick="sendQuickReply('Where do I meet you?')">üìç Location</button>
                            <button class="quick-reply" onclick="sendQuickReply('What should I bring?')">üéí What to Bring</button>
                        </div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', welcomeHtml);
            }

            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.placeholder = "Type your question...";
            chatInput.focus();
            
            console.log('üí¨ Chat interface ready!');
        }

        function showError(message) {
            console.error('Showing error:', message);
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Chat Loading Error</h3>
                    <p>${message}</p>
                    <div style="margin-top: 15px; font-size: 12px; opacity: 0.8;">
                        <strong>Debug Info:</strong><br>
                        Operator ID: ${operatorId || 'Not provided'}<br>
                        URL: ${window.location.href}
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="/setup" style="color: #8B5CF6; text-decoration: underline;">‚Üê Go to Setup</a>
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.disabled = true;
            sendButton.disabled = true;
            
            displayMessage(message, 'user');
            input.value = '';
            
            await sendMessageToServer(message);
            
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }

        // üîß FIXED: Enhanced contact form with better UX
function showContactForm() {
    const businessName = businessConfig.businessName || 'our business';
    const responseTime = businessConfig.responseTime || '30 minutes';
    const smsEnabled = businessConfig.smsEnabled || 'disabled';
    
    // Check if contact form already exists
    if (document.querySelector('.contact-form')) {
        console.log('Contact form already shown');
        return;
    }
    
    let formContent = '';
    
    if (smsEnabled === 'sms-first') {
        formContent = `
            <h4>üì± Let's connect via text!</h4>
            <p>What's your mobile number? We'll send you a quick text so you can chat with us on the go.</p>
            <div class="form-row">
                <input 
                    type="tel" 
                    id="contactPhone" 
                    placeholder="+1 (555) 123-4567" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                    style="font-size: 16px;"
                >
                <input 
                    type="email" 
                    id="contactEmail" 
                    placeholder="Email (optional)" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
            </div>
            <div class="form-buttons">
                <button class="submit-btn" onclick="submitContact()">Send SMS ‚Üí</button>
                <button class="skip-btn" onclick="skipContact()">Continue here instead</button>
            </div>
            <p class="help-text">We'll send you a text message to start the conversation on your mobile device</p>
        `;
    } else {
        formContent = `
            <h4>üëã Quick question first!</h4>
            <p>Could we get your email so we can send you ${businessConfig.businessType || 'tour'} info and follow up if needed? We typically respond within ${responseTime}.</p>
            <div class="form-row">
                <input 
                    type="email" 
                    id="contactEmail" 
                    placeholder="your@email.com" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
                <input 
                    type="tel" 
                    id="contactPhone" 
                    placeholder="Phone (optional)" 
                    onkeypress="if(event.key==='Enter') submitContact()"
                >
            </div>
            <div class="form-buttons">
                <button class="submit-btn" onclick="submitContact()">Continue ‚Üí</button>
                <button class="skip-btn" onclick="skipContact()">Skip for now</button>
            </div>
            <p class="help-text">We'll use this to send you ${businessConfig.businessType || 'tour'} details and follow up if you have questions later</p>
        `;
    }
    
    const contactFormHtml = `
        <div class="message bot-message" id="contactFormMessage">
            <div class="contact-form">
                ${formContent}
            </div>
        </div>
    `;
    
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.insertAdjacentHTML('beforeend', contactFormHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Focus appropriate field after form appears
    setTimeout(() => {
        if (smsEnabled === 'sms-first') {
            const phoneInput = document.getElementById('contactPhone');
            if (phoneInput) phoneInput.focus();
        } else {
            const emailInput = document.getElementById('contactEmail');
            if (emailInput) emailInput.focus();
        }
    }, 100);
}

        // üîß FIXED: Enhanced contact submission with better validation
async function submitContact() {
    const emailInput = document.getElementById('contactEmail');
    const phoneInput = document.getElementById('contactPhone');
    
    if (!emailInput || !phoneInput) {
        console.error('Contact form inputs not found');
        return;
    }
    
    const email = emailInput.value.trim();
    const phone = phoneInput.value.trim();
    const smsEnabled = businessConfig.smsEnabled || 'disabled';
    
    // Validation based on SMS mode
    if (smsEnabled === 'sms-first') {
        const phoneRegex = /^\+?[\s\-\(\)]*([0-9][\s\-\(\)]*){10,}$/;
        if (!phone || !phoneRegex.test(phone)) {
            phoneInput.style.borderColor = '#EF4444';
            phoneInput.placeholder = 'Please enter a valid phone number';
            phoneInput.value = '';
            phoneInput.focus();
            return;
        }
    } else {
        // Email mode - require email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!email || !emailRegex.test(email)) {
            emailInput.style.borderColor = '#EF4444';
            emailInput.placeholder = 'Please enter a valid email';
            emailInput.value = '';
            emailInput.focus();
            return;
        }
    }
    
    // Mark as provided to prevent showing again
    hasProvidedContact = true;
    
    try {
        const response = await fetch(`${serverUrl}/contact-info`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                email: email || null, 
                phone: phone || null, 
                operatorId: operatorId,
                sessionId: 'default'
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to save contact info');
        }
        
        console.log('üìß Contact info saved:', { email, phone, operatorId });
        
        // Replace form with success message
        const contactFormMessage = document.getElementById('contactFormMessage');
        if (contactFormMessage) {
            let successMessage = '';
            
            if (smsEnabled === 'sms-first') {
                successMessage = '‚ú® Perfect! Now let me help you with your question, and we\'ll send you a text shortly...';
            } else {
                successMessage = '‚ú® Perfect! Now let me help you with your question...';
            }
            
            contactFormMessage.innerHTML = `
                <div style="
                    color: #059669; 
                    font-weight: 600; 
                    font-size: 14px;
                    text-align: center;
                    padding: 16px;
                    background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
                    border-radius: 12px;
                    border: 1px solid #a7f3d0;
                ">
                    ${successMessage}
                </div>
            `;
        }
        
        // Process pending message after brief delay
        setTimeout(async () => {
            if (pendingMessage) {
                await sendMessageToServer(pendingMessage);
                pendingMessage = null;
            }
        }, 1500);
        
    } catch (error) {
        console.error('Error saving contact:', error);
        // Fall back to skip behavior
        skipContact();
    }
}

// üîß FIXED: Enhanced skip function
function skipContact() {
    hasProvidedContact = true;
    
    const contactFormMessage = document.getElementById('contactFormMessage');
    if (contactFormMessage) {
        contactFormMessage.remove();
    }
    
    // Process pending message immediately
    if (pendingMessage) {
        sendMessageToServer(pendingMessage);
        pendingMessage = null;
    }
}

        // FIXED: Enhanced sendMessageToServer function with proper contact form handling
async function sendMessageToServer(message) {
    showTyping();
    
    try {
        console.log('üì§ Sending message:', message);
        const response = await fetch(`${serverUrl}/api/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                message: message,
                operatorId: operatorId 
            })
        });
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì® Server response:', data);
        hideTyping();
        
        if (data.skipBotResponse) {
            console.log('üí¨ Operator is active - no bot response needed');
            return;
        }
        
        if (data.operatorJoined) {
            displayMessage('üë®‚Äçüíº A team member has joined the chat to assist you personally!', 'system');
        }
        
        if (data.response) {
            displayMessage(data.response, data.fromOperator ? 'operator' : 'bot');
            
            // Execute any JavaScript that might be in the response
            setTimeout(() => {
                const scripts = document.querySelectorAll('.bot-message script');
                scripts.forEach(script => {
                    try {
                        eval(script.innerHTML);
                    } catch (e) {
                        console.log('Script execution skipped:', e);
                    }
                });
            }, 100);
        }

        // üîß FIXED: Proper contact form handling
        if (data.showContactForm) {
            console.log('üìã Showing contact form...');
            
            // Store pending message if provided
            if (data.pendingMessage) {
                pendingMessage = data.pendingMessage;
            }
            
            // Show contact form after a brief delay
            setTimeout(() => {
                showContactForm();
            }, 500);
        }
        
        if (data.agentRequested || data.operatorJoined || data.startPolling || data.twoWayChat || data.continuePolling) {
            console.log('üîÑ Starting/continuing message polling...');
            startOperatorMessagePolling();
            
            if (data.smsEnabled && data.smsMode === 'hybrid') {
                setTimeout(() => {
                    showSMSNotification('üí¨ Two-way chat active! You can also text us if you prefer mobile messaging.', '#8B5CF6');
                }, 2000);
            } else if (data.smsEnabled && data.smsMode === 'sms-first') {
                setTimeout(() => {
                    showSMSNotification('üì± SMS conversation started! Continue on your mobile device.', '#10b981');
                }, 2000);
            } else if (data.twoWayChat) {
                setTimeout(() => {
                    showSMSNotification('üí¨ Two-way chat active - team member will respond here!', '#8B5CF6');
                }, 2000);
            } else if (data.agentRequested) {
                setTimeout(() => {
                    showSMSNotification('üë®‚Äçüíº Team member will contact you soon...', '#10b981');
                }, 2000);
            }
        }
        
    } catch (error) {
        console.error('üí• Chat error:', error);
        hideTyping();
        displayMessage('Sorry, I\'m having connection issues. Please try again or contact us directly.', 'bot');
    }
}

        function showSMSNotification(message, color = '#8B5CF6') {
            const existing = document.getElementById('sms-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'sms-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, ${color}, ${darkenColor(color, 15)});
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10002;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                max-width: 350px;
                animation: slideInRight 0.5s ease-out;
                cursor: pointer;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div>${message}</div>
                    <div style="margin-left: auto; opacity: 0.7; font-size: 18px;">√ó</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 8000);
            
            notification.addEventListener('click', () => {
                notification.style.animation = 'slideOutRight 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            });
        }

        function sendQuickReply(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        function displayMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let messageClass = `message ${sender}-message`;
            let displayText = text;
            
            if (sender === 'operator') {
                messageClass = 'message operator-message';
                
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmESBkCU2fPFdSYELYDN8+OLOgcZZ7zq559NEAxQp+PwtmUeBC+Gzs/kgCECHm224+KEQQE');
                    audio.volume = 0.1;
                    audio.play().catch(() => {});
                } catch (e) {
                    // Ignore audio errors
                }
            } else if (sender === 'system') {
                messageClass = 'message system-message';
            }
            
            messageDiv.className = messageClass;
            messageDiv.innerHTML = displayText;
            messagesContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function startOperatorMessagePolling() {
            if (pollingInterval) {
                console.log('üîÑ Polling already active, skipping...');
                return;
            }
            
            console.log('üîÑ Starting enhanced operator message polling...');
            let consecutiveErrors = 0;
            let pollCount = 0;
            
            pollingInterval = setInterval(async () => {
                try {
                    pollCount++;
                    console.log(`üì° Polling attempt #${pollCount} (lastMessageCount: ${lastMessageCount})`);
                    
                    const response = await fetch(`${serverUrl}/api/chat/poll-messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            operatorId: operatorId,
                            sessionId: 'default',
                            lastMessageCount: lastMessageCount
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì¨ Poll response:', data);
                    
                    if (data.success && data.newMessages && data.newMessages.length > 0) {
                        console.log(`üì• Received ${data.newMessages.length} new messages`);
                        
                        data.newMessages.forEach(msg => {
                            console.log('üì® Processing message:', msg);
                            
                            if (msg.role === 'operator') {
                                displayMessage(msg.content, 'operator');
                                
                                if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                                    new Notification('Team Member Responded!', {
                                        body: msg.content.substring(0, 100),
                                        icon: '/favicon.ico'
                                    });
                                }
                                
                                const typingIndicator = document.getElementById('typingIndicator');
                                if (typingIndicator.classList.contains('operator-typing')) {
                                    hideTyping();
                                }
                                
                            } else if (msg.role === 'system') {
                                displayMessage(msg.content, 'system');
                            }
                        });
                        
                        lastMessageCount = data.totalMessages;
                        consecutiveErrors = 0;
                    }
                    
                    if (data.operatorTyping) {
                        showOperatorTyping();
                    }
                    
                } catch (error) {
                    consecutiveErrors++;
                    console.error(`‚ùå Polling error #${consecutiveErrors}:`, error);
                    
                    if (consecutiveErrors >= 3) {
                        console.log('üîÑ Too many errors, restarting polling...');
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        
                        const backoffTime = Math.min(1000 * Math.pow(2, consecutiveErrors - 3), 30000);
                        setTimeout(() => {
                            if (!pollingInterval) {
                                startOperatorMessagePolling();
                            }
                        }, backoffTime);
                        return;
                    }
                }
            }, 1000);
        }

        function showOperatorTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';
            typingIndicator.classList.add('operator-typing');
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            setTimeout(() => {
                if (typingIndicator.classList.contains('operator-typing')) {
                    hideTyping();
                }
            }, 5000);
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'none';
            typingIndicator.classList.remove('operator-typing');
        }

        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && lastMessageCount > 0 && !pollingInterval) {
                startOperatorMessagePolling();
            }
        });

        window.addEventListener('resize', function() {
            const chatInput = document.getElementById('chatInput');
            if (window.innerWidth <= 768) {
                chatInput.style.fontSize = '16px';
            }
        });

        setInterval(() => {
            if (pollingInterval) {
                fetch(`${serverUrl}/api/test`, { method: 'HEAD' }).catch(() => {});
            }
        }, 30000);

        // MISSING FUNCTIONS for hybrid chat buttons
window.selectChatChoice = function(choice) {
    console.log('Choice selected:', choice);
    
    // Disable buttons to prevent double-clicks
    document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    });
    
    if (choice === 'sms') {
        // Show phone number collection
        showPhoneCollection();
    } else {
        // Continue with regular chat handoff
        sendMessageToServer('I prefer to continue chatting here');
    }
};

window.showPhoneCollection = function() {
    // Find the button container and replace it with phone input
    const choiceContainer = document.querySelector('.choice-btn').closest('div');
    if (choiceContainer) {
        choiceContainer.innerHTML = `
            <div style="text-align: center; margin: 15px 0;">
                <h4 style="margin: 0 0 12px 0; color: #1f2937;">üì± What's your mobile number?</h4>
                <input type="tel" id="hybridPhoneInput" placeholder="+1 (555) 123-4567" style="
                    width: 100%;
                    padding: 12px;
                    border: 2px solid #e5e7eb;
                    border-radius: 8px;
                    font-size: 16px;
                    margin-bottom: 12px;
                " onkeypress="if(event.key==='Enter') submitHybridPhone()">
                <button onclick="submitHybridPhone()" style="
                    width: 100%;
                    padding: 12px;
                    background: #8B5CF6;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 600;
                    cursor: pointer;
                ">Send me a text! üì±</button>
            </div>
        `;
        
        // Focus on the phone input
        setTimeout(() => {
            const phoneInput = document.getElementById('hybridPhoneInput');
            if (phoneInput) {
                phoneInput.focus();
            }
        }, 100);
    }
};

window.submitHybridPhone = function() {
    const phoneInput = document.getElementById('hybridPhoneInput');
    if (!phoneInput) {
        console.error('Phone input not found');
        return;
    }
    
    const phone = phoneInput.value.trim();
    
    if (!phone) {
        phoneInput.style.borderColor = '#ef4444';
        phoneInput.placeholder = 'Please enter your phone number';
        phoneInput.focus();
        return;
    }
    
    // Validate phone number format
    const phoneRegex = /^\+?[\s\-\(\)]*([0-9][\s\-\(\)]*){10,}$/;
    if (!phoneRegex.test(phone)) {
        phoneInput.style.borderColor = '#ef4444';
        phoneInput.placeholder = 'Please enter a valid phone number';
        phoneInput.value = '';
        phoneInput.focus();
        return;
    }
    
    // Send the phone number as a message
    console.log('Submitting phone number:', phone);
    sendMessageToServer(phone);
};

// Also add this helper function for debugging
window.sendMessageToServer = window.sendMessageToServer || sendMessageToServer;

        console.log('üéâ Enhanced chat script loaded successfully!');
    </script>
</body>
</html>